name: ORT License Compliance Scan

on:
  workflow_dispatch:
    inputs:
      vcs_url:
        description: 'Repository URL to scan'
        required: true
        default: 'https://github.com/vercel/next.js'
      github_token:
        description: 'GitHub Personal Access Token (optional)'
        required: false
        default: ''

jobs:
  ort-scan:
    runs-on: ubuntu-latest
    name: ORT License Compliance Check
    permissions:
      contents: read
      security-events: write

    steps:
    # ----------------------------------------------------
    # 1️⃣ Checkout ONLY ORT configuration (separate folder)
    # ----------------------------------------------------
    - name: Checkout ORT config
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: ".ort-config"

    - name: Setup ORT configuration
      run: |
        mkdir -p "$HOME/.ort/config"
        cp .ort-config/evaluator.rules.kts "$HOME/.ort/config/" || true
        cp .ort-config/license-classifications.yml "$HOME/.ort/config/" || true

    # ----------------------------------------------------
    # 2️⃣ Detect Primary Language (NO CLONING)
    # ----------------------------------------------------
    - name: Detect primary language
      id: detect_rust
      run: |
        OWNER=$(echo "${{ github.event.inputs.vcs_url }}" | sed -E 's|.*github\.com[:/]([^/]+)/.*|\1|')
        REPO=$(echo "${{ github.event.inputs.vcs_url }}" | sed -E 's|.*github\.com[:/][^/]+/([^/.]+).*|\1|')

        LANGUAGE=$(curl -s https://api.github.com/repos/$OWNER/$REPO | jq -r '.language')

        echo "Primary language: $LANGUAGE"

        if [ "$LANGUAGE" = "Rust" ]; then
          echo "rust=true" >> $GITHUB_OUTPUT
        else
          echo "rust=false" >> $GITHUB_OUTPUT
        fi

    # ----------------------------------------------------
    # 3️⃣ Show Available Memory
    # ----------------------------------------------------
    - name: Show memory info
      run: free -h

    # ----------------------------------------------------
    # 4️⃣ Run ORT (Default Mode - Cargo Disabled)
    # ----------------------------------------------------
    - name: Run ORT (Default Mode)
      if: steps.detect_rust.outputs.rust == 'false'
      uses: oss-review-toolkit/ort-ci-github-action@v1
      env:
        ORT_DOCKER_OPTIONS: "--memory=12g --memory-swap=12g"
        ORT_JAVA_OPTS: "-Xmx8g -Xms4g"
        GITHUB_TOKEN: ${{ github.event.inputs.github_token || secrets.GITHUB_TOKEN }}
      with:
        vcs-url: '${{ github.event.inputs.vcs_url }}'
        allow-dynamic-versions: 'false'
        run: >-
          cache-dependencies,
          labels,
          analyzer,
          scanner,
          advisor,
          evaluator,
          reporter,
          upload-results
        ort-cli-args: >-
          -P ort.analyzer.enabledPackageManagers=NPM,Yarn,PNPM,Maven,Gradle
          -P ort.scanner.skipExcluded=true
          -P ort.analyzer.enableNestedDependencies=false

    # ----------------------------------------------------
    # 5️⃣ Run ORT (Rust Mode - Cargo Enabled)
    # ----------------------------------------------------
    - name: Run ORT (Rust Mode)
      if: steps.detect_rust.outputs.rust == 'true'
      uses: oss-review-toolkit/ort-ci-github-action@v1
      env:
        ORT_DOCKER_OPTIONS: "--memory=12g --memory-swap=12g"
        ORT_JAVA_OPTS: "-Xmx8g -Xms4g"
        GITHUB_TOKEN: ${{ github.event.inputs.github_token || secrets.GITHUB_TOKEN }}
      with:
        vcs-url: '${{ github.event.inputs.vcs_url }}'
        allow-dynamic-versions: 'false'
        run: >-
          cache-dependencies,
          labels,
          analyzer,
          scanner,
          advisor,
          evaluator,
          reporter,
          upload-results
        ort-cli-args: >-
          -P ort.scanner.skipExcluded=true
          -P ort.analyzer.enableNestedDependencies=false
