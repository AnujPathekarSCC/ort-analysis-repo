name: ORT License Compliance Scan

on:
  workflow_dispatch:
    inputs:
      vcs_url:
        description: 'Repository URL to scan'
        required: true
        default: 'https://github.com/vercel/next.js'
      github_token:
        description: 'GitHub Personal Access Token (optional)'
        required: false
        default: ''

jobs:
  ort-scan:
    runs-on: ubuntu-latest
    name: ORT License Compliance Check
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout ORT config
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: ".ort-config"

    - name: Setup ORT configuration
      run: |
        mkdir -p "$HOME/.ort/config"
        mv .ort-config "$HOME/.ort/config"
        cp $HOME/.ort/config/.ort-config/evaluator.rules.kts "$HOME/.ort/config/evaluator.rules.kts"
        cp $HOME/.ort/config/.ort-config/license-classifications.yml "$HOME/.ort/config/license-classifications.yml"

    - name: Detect if repository is Rust-based
      id: detect_rust
      run: |
        echo "Cloning repository to inspect package managers..."
        git clone --depth 1 "${{ github.event.inputs.vcs_url }}" repo || true
        
        if find repo -name "Cargo.toml" | grep -q .; then
          echo "Rust detected"
          echo "rust=true" >> $GITHUB_OUTPUT
        else
          echo "Rust NOT detected"
          echo "rust=false" >> $GITHUB_OUTPUT
        fi

    - name: Show memory info
      run: free -h

    - name: Run ORT (Non-Rust Mode - Default)
      if: steps.detect_rust.outputs.rust == 'false'
      uses: oss-review-toolkit/ort-ci-github-action@v1
      env:
        ORT_DOCKER_OPTIONS: "--memory=12g"
        _JAVA_OPTIONS: "-Xmx10g -Xms4g"
        GITHUB_TOKEN: ${{ github.event.inputs.github_token || secrets.GITHUB_TOKEN }}
      with:
        vcs-url: '${{ github.event.inputs.vcs_url }}'
        run: >-
            cache-dependencies,
            labels,
            analyzer,
            scanner,
            advisor,
            evaluator,
            reporter,
            upload-results
        ort-cli-args: >-
          -P ort.analyzer.enabledPackageManagers=NPM,Yarn,PNPM,Gradle,Maven
          -P ort.scanner.skipExcluded=true
          -P ort.analyzer.enableNestedDependencies=false

    - name: Run ORT (Rust Mode Enabled)
      if: steps.detect_rust.outputs.rust == 'true'
      uses: oss-review-toolkit/ort-ci-github-action@v1
      env:
        ORT_DOCKER_OPTIONS: "--memory=12g"
        _JAVA_OPTIONS: "-Xmx10g -Xms4g"
        GITHUB_TOKEN: ${{ github.event.inputs.github_token || secrets.GITHUB_TOKEN }}
      with:
        vcs-url: '${{ github.event.inputs.vcs_url }}'
        run: >-
            cache-dependencies,
            labels,
            analyzer,
            scanner,
            advisor,
            evaluator,
            reporter,
            upload-results
        ort-cli-args: >-
          -P ort.scanner.skipExcluded=true
          -P ort.analyzer.enableNestedDependencies=false
